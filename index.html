<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
  <title>Lights Out</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
    
    :root{
      --bg:#0a0e1a;
      --card:#0f1729;
      --on:#ffeb3b;
      --on-glow:#fff59d;
      --off:#1a237e;
      --off-dark:#0d1550;
      --accent:#00e5ff;
      --accent-glow:#64ffda;
      --ok:#00ff88;
      --bad:#ff4081;
      --dim:#9e9e9e;
      --text:#e8eaf6;
      --text-dim:#7986cb;
      --glass:rgba(255,255,255,0.05);
      --border:rgba(255,255,255,0.1);
    }
    
    * { box-sizing: border-box; }
    
    html,body{height:100%; margin:0; overflow-x:hidden;}
    
    body{
      display:grid;
      place-items:center;
      background: 
        linear-gradient(135deg, #0a0e1a 0%, #1a237e 50%, #0a0e1a 100%),
        radial-gradient(ellipse at top left, rgba(0,229,255,0.15) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(255,235,59,0.1) 0%, transparent 50%);
      background-size: 200% 200%, 100% 100%, 100% 100%;
      animation: backgroundShift 20s ease infinite;
      color:var(--text);
      font-family: 'Orbitron', monospace;
      position: relative;
    }
    
    @keyframes backgroundShift {
      0%, 100% { background-position: 0% 50%, 0% 0%, 100% 100%; }
      50% { background-position: 100% 50%, 100% 100%, 0% 0%; }
    }
    
    /* 背景のパーティクル */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
    
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--accent);
      border-radius: 50%;
      opacity: 0;
      animation: floatParticle 10s infinite;
    }
    
    @keyframes floatParticle {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      10% { opacity: 0.5; }
      90% { opacity: 0.5; }
      100% { transform: translateY(-100px) scale(1); opacity: 0; }
    }
    
    .wrap{
      width:min(780px,94vw);
      position: relative;
      z-index: 10;
      animation: slideIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes slideIn {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .card{
      background: linear-gradient(135deg, var(--card), rgba(15,23,41,0.95));
      backdrop-filter: blur(20px);
      border-radius:24px;
      padding:28px;
      box-shadow:
        0 20px 60px rgba(0,0,0,0.5),
        0 0 100px rgba(0,229,255,0.1),
        inset 0 0 30px rgba(255,255,255,0.02);
      border:1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(0,229,255,0.1) 0%, transparent 70%);
      animation: rotateGlow 20s linear infinite;
      pointer-events: none;
    }
    
    @keyframes rotateGlow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    h1{
      margin:.3rem 0 .6rem;
      font-size:clamp(22px,5vw,36px);
      font-weight:900;
      background: linear-gradient(90deg, var(--accent), var(--on), var(--accent));
      background-size: 200% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: textGradient 3s ease infinite;
      text-transform: uppercase;
      letter-spacing: 2px;
      position: relative;
    }
    
    @keyframes textGradient {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    
    .status{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin:12px 0 20px;
      position: relative;
    }
    
    .pill{
      background: linear-gradient(135deg, var(--glass), rgba(255,255,255,0.02));
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      padding:8px 14px;
      border-radius:999px;
      font-weight:600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .pill::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .pill:hover::before {
      left: 100%;
    }
    
    .pill b {
      color: var(--accent);
      text-shadow: 0 0 10px rgba(0,229,255,0.5);
    }
    
    .goal-glow{
      color: var(--on);
      text-shadow:
        0 0 20px rgba(255,235,59,0.8),
        0 0 40px rgba(255,235,59,0.6),
        0 0 60px rgba(255,235,59,0.4);
      font-weight:900;
      animation: pulse 1.5s ease infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .goal-dim{
      color: var(--dim);
      font-weight:900;
      font-size:1.15em;
      text-transform: uppercase;
    }
    
    /* グリッド */
    .grid{
      --s:72px;
      display:grid;
      grid-template-columns:repeat(var(--n,5), var(--s));
      gap:10px;
      margin: calc(var(--s) * 1.5) auto;
      justify-content:center;
      position: relative;
      padding: 20px;
      border-radius: 20px;
      background: radial-gradient(ellipse at center, rgba(0,229,255,0.05) 0%, transparent 70%);
    }
    
    @media (max-width:480px){
      .grid{ --s:60px; gap:8px; padding: 15px; }
    }
    
    .cell{
      width:var(--s);
      height:var(--s);
      border-radius:16px;
      cursor:pointer;
      position:relative;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform-style: preserve-3d;
      perspective: 1000px;
    }
    
    .cell::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 120%;
      height: 120%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.4s;
      pointer-events: none;
    }
    
    .cell.on{
      background: 
        radial-gradient(circle at 30% 30%, var(--on-glow), var(--on)),
        linear-gradient(145deg, var(--on), #ffc107);
      box-shadow:
        0 0 30px rgba(255,235,59,0.6),
        0 0 60px rgba(255,235,59,0.4),
        0 8px 16px rgba(0,0,0,0.3),
        inset 0 -2px 4px rgba(255,255,255,0.8),
        inset 0 2px 8px rgba(255,235,59,0.5);
      transform: translateZ(10px) scale(1.05);
      animation: lightPulse 2s ease infinite;
    }
    
    .cell.on::before {
      background: radial-gradient(circle, rgba(255,235,59,0.4) 0%, transparent 70%);
      opacity: 1;
      animation: glowPulse 2s ease infinite;
    }
    
    @keyframes lightPulse {
      0%, 100% { transform: translateZ(10px) scale(1.05); }
      50% { transform: translateZ(15px) scale(1.08); }
    }
    
    @keyframes glowPulse {
      0%, 100% { transform: translate(-50%, -50%) scale(1); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
    }
    
    .cell.off{
      background:
        linear-gradient(145deg, var(--off-dark), var(--off)),
        radial-gradient(circle at 70% 70%, var(--off), var(--off-dark));
      box-shadow:
        inset 0 4px 8px rgba(0,0,0,0.5),
        inset 0 -2px 4px rgba(26,35,126,0.3),
        0 2px 4px rgba(0,0,0,0.3);
      transform: translateZ(0) scale(1);
    }
    
    .cell:hover {
      transform: translateZ(20px) scale(1.1) rotate(2deg);
      transition-duration: 0.2s;
    }
    
    .cell.hint{
      outline:3px solid var(--accent);
      box-shadow:
        0 0 30px rgba(0,229,255,0.6),
        0 0 60px rgba(0,229,255,0.3),
        inset 0 0 20px rgba(0,229,255,0.2);
      animation: hintBlink 0.8s ease infinite;
    }
    
    @keyframes hintBlink {
      0%, 100% { outline-color: var(--accent); transform: scale(1); }
      50% { outline-color: var(--accent-glow); transform: scale(1.1); }
    }
    
    .buttons{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      justify-content:center;
      margin-top:calc(var(--s) * 1.5);
      position: relative;
    }
    
    button{
      background: linear-gradient(135deg, var(--glass), rgba(0,229,255,0.1));
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      color:var(--text);
      padding:12px 20px;
      border-radius:16px;
      font-weight:700;
      cursor:pointer;
      font-family: 'Orbitron', monospace;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: radial-gradient(circle, var(--accent), transparent);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow:
        0 10px 20px rgba(0,229,255,0.2),
        0 4px 8px rgba(0,0,0,0.3);
      border-color: var(--accent);
    }
    
    button:hover::before {
      width: 300px;
      height: 300px;
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .banner{
      text-align:center;
      font-weight:900;
      margin-top:20px;
      font-size:1.2em;
      text-transform: uppercase;
      letter-spacing: 2px;
      min-height: 30px;
    }
    
    .win{
      color:var(--ok);
      text-shadow:
        0 0 20px rgba(0,255,136,0.8),
        0 0 40px rgba(0,255,136,0.6);
      animation: winAnimation 0.6s ease-out;
    }
    
    @keyframes winAnimation {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .nosolve{
      color:var(--bad);
      text-shadow:
        0 0 20px rgba(255,64,129,0.8),
        0 0 40px rgba(255,64,129,0.6);
    }
    
    select{
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--glass);
      backdrop-filter: blur(10px);
      color:var(--text);
      font-family: 'Orbitron', monospace;
      font-weight:600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    select:hover {
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(0,229,255,0.3);
    }
    
    option {
      background: var(--card);
      color: var(--text);
    }
    
    /* 勝利時の花火エフェクト */
    .firework {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
    }
    
    .firework-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: explode 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
    
    @keyframes explode {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }
    
    /* 勝利時の波紋エフェクト */
    .victory-wave {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 100px;
      height: 100px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 9998;
    }
    
    .wave-ring {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px solid var(--ok);
      border-radius: 50%;
      opacity: 0;
      animation: waveExpand 2s ease-out forwards;
    }
    
    @keyframes waveExpand {
      0% {
        width: 0;
        height: 0;
        opacity: 1;
      }
      100% {
        width: 500px;
        height: 500px;
        opacity: 0;
      }
    }
  </style>
</head>
<body>
<div class="particles" id="particles"></div>

<div class="wrap card">
  <h1>Lights Out</h1>
  <div class="status">
    <div class="pill">難易度:
      <select id="level" aria-label="難易度">
        <option value="3">★ (3×3)</option>
        <option value="4">★★ (4×4)</option>
        <option value="5" selected>★★★ (5×5)</option>
        <option value="6">★★★★ (6×6)</option>
        <option value="7">★★★★★ (7×7)</option>
      </select>
    </div>
    <div class="pill">目標: <b id="goalText"></b></div>
    <div class="pill">手数: <b id="moves">0</b></div>
    <div class="pill">点灯数: <b id="litCount">0</b> / <b id="sizeLabel">25</b></div>
  </div>

  <div class="grid" id="grid" style="--n:5"></div>

  <div class="buttons">
    <button id="newBtn">新しい問題</button>
    <button id="undoBtn">ひとつ戻す</button>
    <button id="resetBtn">最初に戻す</button>
    <button id="hintBtn">1手ヒント</button>
    <button id="giveupBtn">ギブアップ</button>
  </div>

<footer style="padding:20px; margin-top:40px; text-align:center; color:white;">
  <nav style="margin-bottom:15px;">
    <a href="https://justy.co.jp/games/privacy.html" style="color:#667eea; opacity:0.8; margin:0 9px; text-decoration:none;">プライバシーポリシー</a>
    <a href="https://justy.co.jp/games/terms.html" style="color:#667eea; opacity:0.8;margin:0 9px; text-decoration:none;">利用規約</a>
    <a href="https://justy.co.jp/games/contact.html" style="color:#667eea; opacity:0.8; margin:0 9px; text-decoration:none;">お問い合わせ</a>
    <a href="https://justy.co.jp/games/about.html" style="color:#667eea; opacity:0.8; margin:0 9px; text-decoration:none;">サイトについて</a>
  </nav>
  <p style="font-size:0.9rem; opacity:0.8; color:#667eea">© 2025 Justy Web Games. Hiroyuki Itoh All Right Reserved.</p>
</footer>

  <div class="banner" id="banner"></div>
</div>

<script>
(function(){
  // ==== 設定（ギブアップ適用のスピード）====
  const GIVEUP_SPEED_MS = 1500; // 指定どおり 1500ms に設定

  // ==== 状態変数 ====
  let N = 5, SIZE = 25;
  let A = [];              // 作用行列（SIZE×SIZE）
  let board = [], startBoard = [], moves = 0, history = [];
  let goalAllOn = false;   // false=全消灯, true=全点灯
  let isWinAnimating = false; // 勝利アニメーション中フラグ

  // ==== 要素参照 ====
  const gridEl   = document.getElementById('grid');
  const movesEl  = document.getElementById('moves');
  const litEl    = document.getElementById('litCount');
  const sizeEl   = document.getElementById('sizeLabel');
  const bannerEl = document.getElementById('banner');
  const goalLbl  = document.getElementById('goalLabel');
  const goalTxt  = document.getElementById('goalText');
  const selLevel = document.getElementById('level');
  const btnNew   = document.getElementById('newBtn');
  const btnUndo  = document.getElementById('undoBtn');
  const btnReset = document.getElementById('resetBtn');
  const btnHint  = document.getElementById('hintBtn');
  const btnGive  = document.getElementById('giveupBtn');

  // ==== 背景パーティクル生成 ====
  function createParticles() {
    const container = document.getElementById('particles');
    for (let i = 0; i < 30; i++) {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 10 + 's';
      particle.style.animationDuration = (10 + Math.random() * 10) + 's';
      container.appendChild(particle);
    }
  }
  createParticles();

  // ==== 行列生成（自分＋上下左右に1）====
  function buildMatrix(){
    SIZE = N*N;
    A = Array.from({length: SIZE}, () => Array(SIZE).fill(0));
    for(let r=0;r<N;r++){
      for(let c=0;c<N;c++){
        const i = r*N+c;
        for(const [rr,cc] of [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]]){
          if(rr>=0 && rr<N && cc>=0 && cc<N) A[rr*N+cc][i] = 1;
        }
      }
    }
  }

  // ==== GF(2) ガウス消去（解が一意でなくても1解を返す）====
  function solve(M, b){
    const n = M.length, m = M[0].length;
    const aug = M.map((row,i)=> row.slice().concat([b[i]||0]));
    let row=0; const where = Array(m).fill(-1);
    for(let col=0; col<m && row<n; col++){
      let sel=row; for(let i=row;i<n;i++){ if(aug[i][col]){ sel=i; break; } }
      if(!aug[sel][col]) continue;
      [aug[row],aug[sel]] = [aug[sel],aug[row]];
      where[col]=row;
      for(let i=0;i<n;i++) if(i!==row && aug[i][col]){
        for(let j=col;j<=m;j++) aug[i][j] ^= aug[row][j];
      }
      row++;
    }
    for(let i=row;i<n;i++) if(aug[i][m]) return null; // 矛盾→解なし
    const x = Array(m).fill(0);
    for(let col=0; col<m; col++) if(where[col]!==-1) x[col] = aug[where[col]][m];
    return x;
  }

  // ==== グリッド構築とレイアウト調整 ====
  function buildGrid(){
    gridEl.innerHTML='';
    gridEl.style.setProperty('--n', N); // 列数
    // セルを生成
    for(let i=0;i<SIZE;i++){
      const d = document.createElement('div');
      d.className = 'cell off';
      d.addEventListener('click', ()=> {
        if (!isWinAnimating) press(i);
      });
      gridEl.appendChild(d);
    }
    fitCellSize();
  }

  // 端末幅に合わせてセルサイズを決定
  function fitCellSize(){
    const wrapW = Math.min(780, document.documentElement.clientWidth*0.94);
    const gap   = 10;
    const maxCell = 72, minCell = 44;
    const cell = Math.max(minCell, Math.min(maxCell, Math.floor((wrapW - (N-1)*gap)/N)));
    gridEl.style.setProperty('--s', cell+'px');
  }
  window.addEventListener('resize', fitCellSize);

  // ==== 花火エフェクト ====
  function createFirework(x, y) {
    const colors = ['#ffeb3b', '#00e5ff', '#00ff88', '#ff4081', '#e91e63', '#9c27b0'];
    const firework = document.createElement('div');
    firework.className = 'firework';
    firework.style.left = x + 'px';
    firework.style.top = y + 'px';
    
    for (let i = 0; i < 30; i++) {
      const particle = document.createElement('div');
      particle.className = 'firework-particle';
      const angle = (Math.PI * 2 * i) / 30;
      const velocity = 100 + Math.random() * 100;
      const color = colors[Math.floor(Math.random() * colors.length)];
      
      particle.style.backgroundColor = color;
      particle.style.boxShadow = `0 0 6px ${color}`;
      particle.style.setProperty('--tx', Math.cos(angle) * velocity + 'px');
      particle.style.setProperty('--ty', Math.sin(angle) * velocity + 'px');
      
      particle.style.animation = `explode ${1 + Math.random() * 0.5}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`;
      
      // カスタムアニメーションを追加
      const style = document.createElement('style');
      style.textContent = `
        @keyframes explode${i} {
          0% {
            transform: translate(0, 0) scale(1);
            opacity: 1;
          }
          100% {
            transform: translate(${Math.cos(angle) * velocity}px, ${Math.sin(angle) * velocity}px) scale(0);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
      particle.style.animation = `explode${i} ${1 + Math.random() * 0.5}s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards`;
      
      firework.appendChild(particle);
    }
    
    document.body.appendChild(firework);
    setTimeout(() => firework.remove(), 2000);
  }

  // ==== 波紋エフェクト ====
  function createVictoryWave() {
    const wave = document.createElement('div');
    wave.className = 'victory-wave';
    
    for (let i = 0; i < 3; i++) {
      const ring = document.createElement('div');
      ring.className = 'wave-ring';
      ring.style.animationDelay = i * 0.2 + 's';
      wave.appendChild(ring);
    }
    
    document.body.appendChild(wave);
    setTimeout(() => wave.remove(), 2000);
  }

  // ==== 勝利演出 ====
  function triggerVictoryAnimation() {
    isWinAnimating = true;
    
    // 波紋エフェクト
    createVictoryWave();
    
    // 複数の花火を時間差で発射
    const positions = [
      { x: window.innerWidth * 0.2, y: window.innerHeight * 0.3 },
      { x: window.innerWidth * 0.8, y: window.innerHeight * 0.3 },
      { x: window.innerWidth * 0.5, y: window.innerHeight * 0.5 },
      { x: window.innerWidth * 0.3, y: window.innerHeight * 0.6 },
      { x: window.innerWidth * 0.7, y: window.innerHeight * 0.6 }
    ];
    
    positions.forEach((pos, i) => {
      setTimeout(() => {
        createFirework(pos.x, pos.y);
      }, i * 200);
    });
    
    // セルの勝利アニメーション
    const cells = gridEl.children;
    for (let i = 0; i < SIZE; i++) {
      setTimeout(() => {
        cells[i].style.transition = 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
        cells[i].style.transform = 'scale(1.2) rotate(360deg)';
        setTimeout(() => {
          cells[i].style.transform = 'scale(1) rotate(0deg)';
        }, 500);
      }, i * 30);
    }
    
    // グリッド全体を振動
    gridEl.style.animation = 'shake 0.5s';
    setTimeout(() => {
      gridEl.style.animation = '';
    }, 500);
    
    // アニメーション終了後フラグをリセット
    setTimeout(() => {
      isWinAnimating = false;
    }, 3000);
  }

  // 振動アニメーション用のスタイル追加
  const shakeStyle = document.createElement('style');
  shakeStyle.textContent = `
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
  `;
  document.head.appendChild(shakeStyle);

  // ==== UI更新 ====
  function updateGrid(){
    let lit=0; const nodes = gridEl.children;
    for(let i=0;i<SIZE;i++){
      nodes[i].classList.toggle('on', !!board[i]);
      nodes[i].classList.toggle('off', !board[i]);
      nodes[i].classList.remove('hint');
      if(board[i]) lit++;
    }
    litEl.textContent = lit;
    // クリア判定
    const target = goalAllOn ? 1 : 0;
    let ok=true; for(let i=0;i<SIZE;i++){ if(board[i]!==target){ ok=false; break; } }
    if(ok){ 
      bannerEl.textContent='クリア！';
      bannerEl.className='banner win';
      // 勝利演出をトリガー
      triggerVictoryAnimation();
    }
    else   { 
      bannerEl.textContent='';
      bannerEl.className='banner';
    }
  }

  // ==== 1マス押す ====
  function press(i){
    history.push(board.slice());
    const r = Math.floor(i/N), c = i%N;
    for(const [rr,cc] of [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]]){
      if(rr>=0&&rr<N&&cc>=0&&cc<N) board[rr*N+cc]^=1;
    }
    moves++; movesEl.textContent = moves;
    updateGrid();
  }

  // ==== 目標テキスト（部分スタイルつき） ====
  function setGoalTexts(){
    if(goalAllOn){
      // すべてを光らせろ！ （「光らせろ！」を点灯色）
      const html = 'すべてを<span class="goal-glow">光らせろ！</span>';
      if(goalLbl) goalLbl.innerHTML = html;
      goalTxt.innerHTML = html;
    }else{
      // すべてを消せ！！ （「消せ！！」を灰色＆一回り大きく）
      const html = 'すべてを<span class="goal-dim">消せ！！</span>';
      if(goalLbl) goalLbl.innerHTML = html;
      goalTxt.innerHTML = html;
    }
  }

  // ==== ランダム可解盤面の生成（A x）====
  function newPuzzle(){
    moves=0; history=[]; bannerEl.textContent=''; bannerEl.className='banner';
    isWinAnimating = false;
    goalAllOn = Math.random()<0.5; // 目標ランダム
    setGoalTexts();

    // 初期点灯数は 25%〜75%
    const MIN_ON = Math.max(1, Math.ceil(SIZE*0.25));
    const MAX_ON = Math.min(SIZE-1, Math.floor(SIZE*0.75));

    let tries=0;
    while(true){
      tries++;
      // ランダムな押し方 x を作り、v = A x を盤面にする（必ず可解）
      const x = Array(SIZE).fill(0).map(()=> Math.random()<0.35?1:0);
      const v = Array(SIZE).fill(0);
      for(let i=0;i<SIZE;i++) if(x[i]){
        for(let j=0;j<SIZE;j++) if(A[j][i]) v[j]^=1;
      }
      const cnt = v.reduce((a,b)=>a+b,0);
      if(cnt>=MIN_ON && cnt<=MAX_ON){
        startBoard = v.slice();
        board = v.slice();
        movesEl.textContent = moves;
        sizeEl.textContent  = SIZE;
        updateGrid();
        break;
      }
      if(tries>800){ // セーフティ：多少条件を緩めて採用
        startBoard = v.slice();
        board = v.slice();
        movesEl.textContent = moves;
        sizeEl.textContent  = SIZE;
        updateGrid();
        break;
      }
    }
  }

  // ==== ヒント／ギブアップ ====
  function solveVectorForCurrent(){
    const target = goalAllOn? Array(SIZE).fill(1) : Array(SIZE).fill(0);
    const rhs = target.map((t,i)=> t ^ board[i]);
    return solve(A, rhs); // null の可能性は理論上ほぼ無し（生成法より）
  }

  btnHint.addEventListener('click', ()=>{
    const nodes = gridEl.children; for(const n of nodes) n.classList.remove('hint');
    const sol = solveVectorForCurrent(); if(!sol) return;
    for(let i=0;i<SIZE;i++) if(sol[i]){ nodes[i].classList.add('hint'); break; }
  });

  btnGive.addEventListener('click', ()=>{
    const sol = solveVectorForCurrent();
    if(!sol){ bannerEl.textContent='解なし'; bannerEl.className='banner nosolve'; return; }
    const seq=[]; for(let i=0;i<SIZE;i++) if(sol[i]) seq.push(i);
    if(!seq.length){ bannerEl.textContent='すでにクリア状態です！'; bannerEl.className='banner win'; return; }
    let k=0; bannerEl.textContent='解答を適用中…'; bannerEl.className='banner';
    const timer = setInterval(()=>{
      press(seq[k]); k++;
      if(k>=seq.length){ clearInterval(timer); }
    }, GIVEUP_SPEED_MS);
  });

  // ==== ナビゲーション ====
  btnNew .addEventListener('click', newPuzzle);
  btnUndo.addEventListener('click', ()=>{
    if(history.length){ board = history.pop(); moves=Math.max(0,moves-1); movesEl.textContent=moves; updateGrid(); }
  });
  btnReset.addEventListener('click', ()=>{ board = startBoard.slice(); moves=0; history=[]; movesEl.textContent=0; updateGrid(); });
  selLevel.addEventListener('change', ()=>{ N = parseInt(selLevel.value,10); buildMatrix(); buildGrid(); newPuzzle(); });

  // ==== 初期化 ====
  buildMatrix();
  buildGrid();
  newPuzzle();
})();
</script>
</body>
</html>